name: Secret Scanning

on:
  workflow_call:
    inputs:
      product:
        description: 'ArmorCode Product/Team name (e.g., Platform, Security, Customer)'
        required: true
        type: string
    secrets:
      ARMORCODE_API_KEY:
        description: 'ArmorCode API key for uploading scan results'
        required: true

jobs:
  trufflehog:
    runs-on: ubuntu-latest
    name: TruffleHog Secret Detection
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # Full git history for comprehensive secret detection
          
      - name: Run TruffleHog (JSON output for ArmorCode)
        run: |
          docker run --rm -v "$PWD:/scan" trufflesecurity/trufflehog:latest \
            git file:///scan --json --only-verified > trufflehog-results.json || true
          
      - name: Upload scan results as artifacts (for ArmorCode ingestion)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trufflehog-results
          path: trufflehog-results.json
      
      - name: Upload to ArmorCode
        if: always()
        env:
          ARMORCODE_API_KEY: ${{ secrets.CHECKR_GITHUB_SCAN_UPLOAD_ARMORCODE_KEY }}
        run: |
          # Check if file is empty and create a valid JSON structure with 0 findings
          if [ ! -s trufflehog-results.json ]; then
            echo '{"findings": [], "metadata": {"scanner": "trufflehog", "scan_time": "'"$(date -u +%Y-%m-%dT%H:%M:%SZ)"'", "total_findings": 0}}' > trufflehog-results.json
          fi
      
          # Get signed URL from ArmorCode
          echo "Requesting signed URL from ArmorCode..."
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST https://app.armorcode.com/client/utils/scan/upload \
            -H "Authorization: Bearer ${ARMORCODE_API_KEY}" \
            -H "Content-Type: application/json" \
            -d '{
              "env": "Production",
              "product": "${{ inputs.product }}",
              "subProduct": "${{ github.event.repository.name }}",
              "scanTool": "TruffleHog",
              "tags": [],
              "fileName": "trufflehog-results.json",
              "fileExtension": ".json"
            }')
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "HTTP Status Code: $HTTP_CODE"
          echo "Response Body: $BODY"
          
          if [ "$HTTP_CODE" -eq 200 ]; then
            SIGNED_URL=$(echo "$BODY" | jq -r '.signedUrl')
            if [ ! -z "$SIGNED_URL" ] && [ "$SIGNED_URL" != "null" ]; then
              echo "Uploading file to ArmorCode..."
              curl -X PUT "$SIGNED_URL" \
                -H "Content-Type: application/json" \
                --data-binary @trufflehog-results.json
              echo "Successfully uploaded to ArmorCode"
            else
              echo "Error: No signedUrl in response"
              exit 1
            fi
          else
            echo "Error: Failed to get signed URL from ArmorCode (HTTP $HTTP_CODE)"
            exit 1
          fi

